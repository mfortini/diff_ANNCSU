<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="generator" content="Observable Framework v1.13.3">
<title>ANNCSU Dashboard | ANNCSU Progress</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" crossorigin>
<link rel="preload" as="style" href="./_observablehq/theme-air,near-midnight.dcdbf18e.css">
<link rel="preload" as="style" href="./_observablehq/stdlib/inputs.ea9fd553.css">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" crossorigin>
<link rel="stylesheet" type="text/css" href="./_observablehq/theme-air,near-midnight.dcdbf18e.css">
<link rel="stylesheet" type="text/css" href="./_observablehq/stdlib/inputs.ea9fd553.css">
<link rel="modulepreload" href="./_observablehq/client.6d4b40e3.js">
<link rel="modulepreload" href="./_observablehq/runtime.e080113b.js">
<link rel="modulepreload" href="./_observablehq/stdlib.73a8ec5a.js">
<link rel="modulepreload" href="./_npm/maplibre-gl@5.14.0/bf489a1e.js">
<link rel="modulepreload" href="./_npm/pmtiles@4.3.0/5b853975.js">
<link rel="modulepreload" href="./_npm/@observablehq/plot@0.6.17/d761ef9b.js">
<link rel="modulepreload" href="./_npm/d3@7.9.0/e780feca.js">
<link rel="modulepreload" href="./_npm/htl@0.3.1/72f4716c.js">
<link rel="modulepreload" href="./_observablehq/stdlib/inputs.4ef1d259.js">
<link rel="modulepreload" href="./_npm/isoformat@0.2.1/18cbf477.js">
<link rel="modulepreload" href="./_npm/fflate@0.8.2/e113a0e7.js">
<link rel="modulepreload" href="./_npm/interval-tree-1d@1.0.4/53fe8176.js">
<link rel="modulepreload" href="./_npm/d3-array@3.2.4/e93ca09f.js">
<link rel="modulepreload" href="./_npm/d3-axis@3.0.0/0f2de24d.js">
<link rel="modulepreload" href="./_npm/d3-brush@3.0.0/65eb105b.js">
<link rel="modulepreload" href="./_npm/d3-chord@3.0.1/7ef8fb2e.js">
<link rel="modulepreload" href="./_npm/d3-color@3.1.0/aeb57b94.js">
<link rel="modulepreload" href="./_npm/d3-contour@4.0.2/1d2aed74.js">
<link rel="modulepreload" href="./_npm/d3-delaunay@6.0.4/5ced1d52.js">
<link rel="modulepreload" href="./_npm/d3-dispatch@3.0.1/9ba9c7f3.js">
<link rel="modulepreload" href="./_npm/d3-drag@3.0.0/4202580c.js">
<link rel="modulepreload" href="./_npm/d3-dsv@3.0.1/9cffc2bd.js">
<link rel="modulepreload" href="./_npm/d3-ease@3.0.1/cdd7e898.js">
<link rel="modulepreload" href="./_npm/d3-fetch@3.0.1/b4e2ad9a.js">
<link rel="modulepreload" href="./_npm/d3-force@3.0.0/5e804d15.js">
<link rel="modulepreload" href="./_npm/d3-format@3.1.0/86074ef6.js">
<link rel="modulepreload" href="./_npm/d3-geo@3.1.1/40599fb3.js">
<link rel="modulepreload" href="./_npm/d3-hierarchy@3.1.2/e49e792c.js">
<link rel="modulepreload" href="./_npm/d3-interpolate@3.0.1/8d1e5425.js">
<link rel="modulepreload" href="./_npm/d3-path@3.1.0/20d3f133.js">
<link rel="modulepreload" href="./_npm/d3-polygon@3.0.1/7553081f.js">
<link rel="modulepreload" href="./_npm/d3-quadtree@3.0.1/0dfd751c.js">
<link rel="modulepreload" href="./_npm/d3-random@3.0.1/3c90ee06.js">
<link rel="modulepreload" href="./_npm/d3-scale@4.0.2/843b6a76.js">
<link rel="modulepreload" href="./_npm/d3-scale-chromatic@3.1.0/ba24c2e7.js">
<link rel="modulepreload" href="./_npm/d3-selection@3.0.0/4d94e5b7.js">
<link rel="modulepreload" href="./_npm/d3-shape@3.2.0/6d3a6726.js">
<link rel="modulepreload" href="./_npm/d3-time@3.1.0/9f03c579.js">
<link rel="modulepreload" href="./_npm/d3-time-format@4.1.0/07c9626f.js">
<link rel="modulepreload" href="./_npm/d3-timer@3.0.1/b58a267d.js">
<link rel="modulepreload" href="./_npm/d3-transition@3.0.1/004da2ac.js">
<link rel="modulepreload" href="./_npm/d3-zoom@3.0.0/b5786b3f.js">
<link rel="modulepreload" href="./_npm/binary-search-bounds@2.0.5/cbf6ba23.js">
<link rel="modulepreload" href="./_npm/internmap@2.0.3/e08981d9.js">
<link rel="modulepreload" href="./_npm/delaunator@5.0.1/02d43215.js">
<link rel="modulepreload" href="./_npm/robust-predicates@3.0.2/aa00730b.js">
<link rel="icon" href="./_file/observable.1af93621.png" type="image/png" sizes="32x32">
<script type="module">

import {define} from "./_observablehq/client.6d4b40e3.js";
import {registerFile} from "./_observablehq/stdlib.73a8ec5a.js";

registerFile("./data/anncsu_2025-09-03.pmtiles.gz", {"name":"./data/anncsu_2025-09-03.pmtiles.gz","mimeType":"application/gzip","path":"./_file/data/anncsu_2025-09-03.pmtiles.200f7e52.gz","lastModified":1765280888430,"size":69670945});
registerFile("./data/anncsu_2025-10-10_missing.pmtiles.gz", {"name":"./data/anncsu_2025-10-10_missing.pmtiles.gz","mimeType":"application/gzip","path":"./_file/data/anncsu_2025-10-10_missing.pmtiles.f4dea627.gz","lastModified":1765280888430,"size":81465});
registerFile("./data/anncsu_2025-10-10_moved.pmtiles.gz", {"name":"./data/anncsu_2025-10-10_moved.pmtiles.gz","mimeType":"application/gzip","path":"./_file/data/anncsu_2025-10-10_moved.pmtiles.d30c102c.gz","lastModified":1765280888430,"size":222489});
registerFile("./data/anncsu_2025-10-10_new.pmtiles.gz", {"name":"./data/anncsu_2025-10-10_new.pmtiles.gz","mimeType":"application/gzip","path":"./_file/data/anncsu_2025-10-10_new.pmtiles.55ad868c.gz","lastModified":1765280888430,"size":2086334});
registerFile("./data/anncsu_2025-11-04_missing.pmtiles.gz", {"name":"./data/anncsu_2025-11-04_missing.pmtiles.gz","mimeType":"application/gzip","path":"./_file/data/anncsu_2025-11-04_missing.pmtiles.e3c0c32d.gz","lastModified":1765280888430,"size":2939112});
registerFile("./data/anncsu_2025-11-04_moved.pmtiles.gz", {"name":"./data/anncsu_2025-11-04_moved.pmtiles.gz","mimeType":"application/gzip","path":"./_file/data/anncsu_2025-11-04_moved.pmtiles.913f7c77.gz","lastModified":1765280888430,"size":313592});
registerFile("./data/anncsu_2025-11-04_new.pmtiles.gz", {"name":"./data/anncsu_2025-11-04_new.pmtiles.gz","mimeType":"application/gzip","path":"./_file/data/anncsu_2025-11-04_new.pmtiles.5f5524e5.gz","lastModified":1765280888430,"size":6859193});
registerFile("./data/anncsu_2025-12-02_missing.pmtiles.gz", {"name":"./data/anncsu_2025-12-02_missing.pmtiles.gz","mimeType":"application/gzip","path":"./_file/data/anncsu_2025-12-02_missing.pmtiles.5cacc980.gz","lastModified":1765280888430,"size":100751});
registerFile("./data/anncsu_2025-12-02_moved.pmtiles.gz", {"name":"./data/anncsu_2025-12-02_moved.pmtiles.gz","mimeType":"application/gzip","path":"./_file/data/anncsu_2025-12-02_moved.pmtiles.07c7ee88.gz","lastModified":1765280888430,"size":3783784});
registerFile("./data/anncsu_2025-12-02_new.pmtiles.gz", {"name":"./data/anncsu_2025-12-02_new.pmtiles.gz","mimeType":"application/gzip","path":"./_file/data/anncsu_2025-12-02_new.pmtiles.64dc85b3.gz","lastModified":1765280888430,"size":33887319});
registerFile("./data/anncsu_spatial_stats.json", {"name":"./data/anncsu_spatial_stats.json","mimeType":"application/json","path":"./_file/data/anncsu_spatial_stats.99c4a9d0.json","lastModified":1765531992387,"size":2678733});
registerFile("./data/anncsu_stats.json", {"name":"./data/anncsu_stats.json","mimeType":"application/json","path":"./_file/data/anncsu_stats.0db1b5d5.json","lastModified":1765531989395,"size":477});

define({id: "2293e18f", inputs: ["html","display"], body: async (html,display) => {
display(await(
html.fragment`<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4/dist/maplibre-gl.css" />`
))
}});

define({id: "4bcc7d2b", inputs: ["Event"], outputs: ["maplibregl","pmtiles","Plot","LayerControl"], body: async (Event) => {
const [{default: maplibregl}, pmtiles, Plot] = await Promise.all([import("./_npm/maplibre-gl@5.14.0/bf489a1e.js"), import("./_npm/pmtiles@4.3.0/5b853975.js"), import("./_npm/@observablehq/plot@0.6.17/d761ef9b.js")]);

// Classe per controllo layer personalizzato
class LayerControl {
  constructor(layerGroups) {
    this._layerGroups = layerGroups;
  }

  onAdd(map) {
    this._map = map;
    this._container = document.createElement('div');
    this._container.className = 'maplibregl-ctrl maplibregl-ctrl-group';

    const wrapper = document.createElement('div');
    wrapper.style.backgroundColor = 'white';
    wrapper.style.padding = '10px';
    wrapper.style.maxHeight = '400px';
    wrapper.style.overflowY = 'auto';
    wrapper.style.minWidth = '200px';

    // Aggiungi ogni gruppo di layer
    this._layerGroups.forEach((group, idx) => {
      if (idx > 0) {
        const separator = document.createElement('hr');
        separator.style.margin = '10px 0';
        separator.style.border = 'none';
        separator.style.borderTop = '1px solid #ddd';
        wrapper.appendChild(separator);
      }

      if (group.title) {
        // Crea checkbox per il gruppo (se ha più di un layer)
        if (group.layers.length > 1) {
          const groupToggle = this._createGroupToggle(group);
          wrapper.appendChild(groupToggle);
        } else {
          // Se ha un solo layer, mostra solo il titolo
          const title = document.createElement('div');
          title.style.fontWeight = 'bold';
          title.style.marginBottom = '5px';
          title.style.fontSize = '13px';
          title.textContent = group.title;
          wrapper.appendChild(title);
        }
      }

      // Container per i layer del gruppo
      const layersContainer = document.createElement('div');
      layersContainer.style.paddingLeft = group.layers.length > 1 ? '20px' : '0';

      group.layers.forEach(({name, layerId, color, visible}) => {
        const layerDiv = this._createLayerToggle(name, layerId, color, visible, group);
        layersContainer.appendChild(layerDiv);
      });

      wrapper.appendChild(layersContainer);
    });

    this._container.appendChild(wrapper);
    return this._container;
  }

  _createGroupToggle(group) {
    const div = document.createElement('div');
    div.style.display = 'flex';
    div.style.alignItems = 'center';
    div.style.gap = '8px';
    div.style.padding = '4px 0';
    div.style.cursor = 'pointer';
    div.style.fontWeight = 'bold';
    div.style.fontSize = '13px';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = false;
    checkbox.id = `group-ctrl-${group.title.replace(/\s+/g, '-')}`;

    const label = document.createElement('label');
    label.htmlFor = checkbox.id;
    label.textContent = group.title;
    label.style.cursor = 'pointer';
    label.style.flex = '1';

    checkbox.addEventListener('click', () => {
      // Se è indeterminate, il click lo rende checked
      // Se è checked, il click lo rende unchecked
      // Se è unchecked, il click lo rende checked
      const newState = checkbox.indeterminate ? true : checkbox.checked;
      checkbox.indeterminate = false;

      group.layers.forEach(({layerId}) => {
        const layerCheckbox = document.getElementById(`layer-ctrl-${layerId}`);
        if (layerCheckbox) {
          layerCheckbox.checked = newState;
          layerCheckbox.dispatchEvent(new Event('change'));
        }
      });
    });

    // Salva il riferimento al checkbox del gruppo
    group._groupCheckbox = checkbox;

    div.appendChild(checkbox);
    div.appendChild(label);

    return div;
  }

  _createLayerToggle(name, layerId, color, visible, group) {
    const div = document.createElement('div');
    div.style.display = 'flex';
    div.style.alignItems = 'center';
    div.style.gap = '8px';
    div.style.padding = '4px 0';
    div.style.cursor = 'pointer';
    div.style.fontSize = '12px';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = visible;
    checkbox.id = `layer-ctrl-${layerId}`;

    const colorCircle = document.createElement('span');
    colorCircle.style.width = '10px';
    colorCircle.style.height = '10px';
    colorCircle.style.borderRadius = '50%';
    colorCircle.style.backgroundColor = color;
    colorCircle.style.display = 'inline-block';
    colorCircle.style.flexShrink = '0';

    const label = document.createElement('label');
    label.htmlFor = checkbox.id;
    label.textContent = name;
    label.style.cursor = 'pointer';
    label.style.flex = '1';

    checkbox.addEventListener('change', () => {
      const visibility = checkbox.checked ? 'visible' : 'none';
      if (this._map.getLayer(layerId)) {
        this._map.setLayoutProperty(layerId, 'visibility', visibility);
      }

      // Aggiorna lo stato del checkbox del gruppo (con tristate)
      if (group && group._groupCheckbox && group.layers.length > 1) {
        const checkedLayers = group.layers.filter(({layerId}) => {
          const cb = document.getElementById(`layer-ctrl-${layerId}`);
          return cb && cb.checked;
        }).length;

        if (checkedLayers === 0) {
          // Nessun layer attivo
          group._groupCheckbox.checked = false;
          group._groupCheckbox.indeterminate = false;
        } else if (checkedLayers === group.layers.length) {
          // Tutti i layer attivi
          group._groupCheckbox.checked = true;
          group._groupCheckbox.indeterminate = false;
        } else {
          // Alcuni layer attivi (stato indeterminato)
          group._groupCheckbox.checked = false;
          group._groupCheckbox.indeterminate = true;
        }
      }
    });

    div.appendChild(checkbox);
    div.appendChild(colorCircle);
    div.appendChild(label);

    return div;
  }

  onRemove() {
    this._container.parentNode.removeChild(this._container);
    this._map = undefined;
  }
}
return {maplibregl,pmtiles,Plot,LayerControl};
}});

define({id: "a28d0326", inputs: ["FileAttachment","d3"], outputs: ["tilesets","anncsu_stats","spatial_stats","idFromName","getLayerId","getSourceId","SmartValue","calculatePercentageChange","formatValue"], body: async (FileAttachment,d3) => {
// Configurazione tilesets
const tilesets = {
  "ANNCSU 2025-09-03": {
    file: FileAttachment("./data/anncsu_2025-09-03.pmtiles.gz"),
    color: "#000000",
    date: "2025-09-03",
    type: "Base (2025-09-03)"
  },
  "ANNCSU 2025-10-10 Rimossi": {
    file: FileAttachment("./data/anncsu_2025-10-10_missing.pmtiles.gz"),
    color: "#e60026",
    date: "2025-10-10",
    type: "Rimossi 2025-10-10"
  },
  "ANNCSU 2025-10-10 Spostati": {
    file: FileAttachment("./data/anncsu_2025-10-10_moved.pmtiles.gz"),
    color: "#15a34a",
    date: "2025-10-10",
    type: "Spostati 2025-10-10"
  },
  "ANNCSU 2025-10-10 Nuovi": {
    file: FileAttachment("./data/anncsu_2025-10-10_new.pmtiles.gz"),
    color: "#0066ff",
    date: "2025-10-10",
    type: "Nuovi 2025-10-10"
  },
  "ANNCSU 2025-11-04 Rimossi": {
    file: FileAttachment("./data/anncsu_2025-11-04_missing.pmtiles.gz"),
    color: "#e60026",
    date: "2025-11-04",
    type: "Rimossi 2025-11-04"
  },
  "ANNCSU 2025-11-04 Spostati": {
    file: FileAttachment("./data/anncsu_2025-11-04_moved.pmtiles.gz"),
    color: "#15a34a",
    date: "2025-11-04",
    type: "Spostati 2025-11-04"
  },
  "ANNCSU 2025-11-04 Nuovi": {
    file: FileAttachment("./data/anncsu_2025-11-04_new.pmtiles.gz"),
    color: "#0066ff",
    date: "2025-11-04",
    type: "Nuovi 2025-11-04"
  },
  "ANNCSU 2025-12-02 Rimossi": {
    file: FileAttachment("./data/anncsu_2025-12-02_missing.pmtiles.gz"),
    color: "#e60026",
    date: "2025-12-02",
    type: "Rimossi 2025-12-02"
  },
  "ANNCSU 2025-12-02 Spostati": {
    file: FileAttachment("./data/anncsu_2025-12-02_moved.pmtiles.gz"),
    color: "#15a34a",
    date: "2025-12-02",
    type: "Spostati 2025-12-02"
  },
  "ANNCSU 2025-12-02 Nuovi": {
    file: FileAttachment("./data/anncsu_2025-12-02_new.pmtiles.gz"),
    color: "#0066ff",
    date: "2025-12-02",
    type: "Nuovi 2025-12-02"
  }
};

const anncsu_stats = await FileAttachment("./data/anncsu_stats.json").json();
const spatial_stats = await FileAttachment("./data/anncsu_spatial_stats.json").json();

// Utilità
const idFromName = (name) => name.toLowerCase().replace(/[^a-z0-9]+/g, "-");
const getLayerId = (name) => `pt-${idFromName(name)}`;
const getSourceId = (name) => `src-${idFromName(name)}`;

class SmartValue extends Number {
  constructor(value, label) {
    super(value);
    this.label = label;
  }
  toString() { return this.label; }
}



// Funzioni per calcolare le percentuali
function calculatePercentageChange(current, previous) {
  if (!previous || previous === 0) return null;
  return ((current - previous) / previous) * 100;
}

function formatValue(value, mode, isPercentage = false) {
  if (value === null || value === undefined) return "-";
  if (mode === "Percentuali" && isPercentage) {
    return value > 0 ? `+${d3.format(".2f")(value)}%` : `${d3.format(".2f")(value)}%`;
  }
  return d3.format(",")(value);
}
return {tilesets,anncsu_stats,spatial_stats,idFromName,getLayerId,getSourceId,SmartValue,calculatePercentageChange,formatValue};
}});

define({id: "cd7947f4", inputs: ["pmtiles","maplibregl","display"], outputs: ["protocol","mapContainer","map","mapLoaded"], body: (pmtiles,maplibregl,display) => {
// Inizializzazione mappa
const protocol = new pmtiles.Protocol({
  metadata: true
});
maplibregl.addProtocol("pmtiles", protocol.tile);

const mapContainer = display(document.createElement("div"));
mapContainer.style.cssText = "width: 100%; height: 800px; border-radius: 8px; overflow: hidden;";

const map = new maplibregl.Map({
  container: mapContainer,
  zoom: 5,
  center: [12.5, 42.5],
  pitch: 0,
  hash: true,
  style: {
    version: 8,
    sources: {
      osm: {
        type: "raster",
        tiles: ["https://a.tile.openstreetmap.org/{z}/{x}/{y}.png"],
        tileSize: 256,
        attribution: "© OpenStreetMap contributors",
        maxzoom: 19
      }
    },
    layers: [{ id: "osm", type: "raster", source: "osm" }]
  },
  maxZoom: 18,
  maxPitch: 85
});

map.addControl(new maplibregl.NavigationControl({
  visualizePitch: true,
  showZoom: true,
  showCompass: true
}));

const mapLoaded = new Promise((resolve) => map.once("load", resolve));
return {protocol,mapContainer,map,mapLoaded};
}});

define({id: "a28d2edd", inputs: ["mapLoaded","getSourceId","getLayerId","map","tilesets"], outputs: ["addPointLayer"], body: async (mapLoaded,getSourceId,getLayerId,map,tilesets) => {
// Caricamento layer
async function addPointLayer(name, config) {
  await mapLoaded;
  
  const sourceId = getSourceId(name);
  const layerId = getLayerId(name);
  const url = `pmtiles://${await config.file.url()}`;

  if (!map.getSource(sourceId)) {
    map.addSource(sourceId, { type: "vector", url });
  }

  if (!map.getLayer(layerId)) {
    // Abilita di default il layer base (ANNCSU 2025-09-03)
    const isBaseLayer = name === "ANNCSU 2025-09-03";

    map.addLayer({
      id: layerId,
      type: "circle",
      source: sourceId,
      "source-layer": "layer0",
      filter: ["==", ["geometry-type"], "Point"],
      paint: {
        "circle-color": config.color,
        "circle-radius": 4,
        "circle-stroke-width": 0,
        "circle-opacity": 0.9
      },
      layout: { visibility: isBaseLayer ? "visible" : "none" }
    });
  }
}

await Promise.all(
  Object.entries(tilesets).map(([name, config]) => addPointLayer(name, config))
);
return {addPointLayer};
}});

define({id: "3497237d", inputs: ["mapLoaded","getLayerId","tilesets","map","LayerControl"], body: async (mapLoaded,getLayerId,tilesets,map,LayerControl) => {
// Aggiungi controllo layer alla mappa
{
  await mapLoaded;

  const layerGroups = [
    {
      title: "Layer Base",
      layers: [
        {
          name: "Base (2025-09-03)",
          layerId: getLayerId("ANNCSU 2025-09-03"),
          color: tilesets["ANNCSU 2025-09-03"].color,
          visible: true
        }
      ]
    },
    {
      title: "Variazioni 2025-10-10",
      layers: [
        {
          name: "Rimossi",
          layerId: getLayerId("ANNCSU 2025-10-10 Rimossi"),
          color: tilesets["ANNCSU 2025-10-10 Rimossi"].color,
          visible: false
        },
        {
          name: "Spostati",
          layerId: getLayerId("ANNCSU 2025-10-10 Spostati"),
          color: tilesets["ANNCSU 2025-10-10 Spostati"].color,
          visible: false
        },
        {
          name: "Nuovi",
          layerId: getLayerId("ANNCSU 2025-10-10 Nuovi"),
          color: tilesets["ANNCSU 2025-10-10 Nuovi"].color,
          visible: false
        }
      ]
    },
    {
      title: "Variazioni 2025-11-04",
      layers: [
        {
          name: "Rimossi",
          layerId: getLayerId("ANNCSU 2025-11-04 Rimossi"),
          color: tilesets["ANNCSU 2025-11-04 Rimossi"].color,
          visible: false
        },
        {
          name: "Spostati",
          layerId: getLayerId("ANNCSU 2025-11-04 Spostati"),
          color: tilesets["ANNCSU 2025-11-04 Spostati"].color,
          visible: false
        },
        {
          name: "Nuovi",
          layerId: getLayerId("ANNCSU 2025-11-04 Nuovi"),
          color: tilesets["ANNCSU 2025-11-04 Nuovi"].color,
          visible: false
        }
      ]
    },
    {
      title: "Variazioni 2025-12-02",
      layers: [
        {
          name: "Rimossi",
          layerId: getLayerId("ANNCSU 2025-12-02 Rimossi"),
          color: tilesets["ANNCSU 2025-12-02 Rimossi"].color,
          visible: false
        },
        {
          name: "Spostati",
          layerId: getLayerId("ANNCSU 2025-12-02 Spostati"),
          color: tilesets["ANNCSU 2025-12-02 Spostati"].color,
          visible: false
        },
        {
          name: "Nuovi",
          layerId: getLayerId("ANNCSU 2025-12-02 Nuovi"),
          color: tilesets["ANNCSU 2025-12-02 Nuovi"].color,
          visible: false
        }
      ]
    }
  ];

  map.addControl(new LayerControl(layerGroups), 'top-right');
}
}});

define({id: "d3c01a2f", inputs: ["view","Inputs"], outputs: ["displayMode"], body: (view,Inputs) => {
// Selettore globale per valori assoluti/percentuali
const displayMode = view(Inputs.radio(
  ["Assoluti", "Percentuali"],
  {label: "Modalità visualizzazione", value: "Assoluti"}
));
return {displayMode};
}});

define({id: "6e74da5a", inputs: ["Plot","width","displayMode","anncsu_stats","d3","display"], body: async (Plot,width,displayMode,anncsu_stats,d3,display) => {
display(await(
Plot.plot({
  title: "Andamento civici geolocalizzati su ANNCSU",
  width,
  marginLeft: 60,
  marginBottom: 60,
  marks: displayMode === "Percentuali"
    ? [
        Plot.line(
          anncsu_stats.map(d => ({
            date: d.date,
            percent: d.total_all ? (d.total / d.total_all) * 100 : 0
          })),
          {
            x: d => new Date(d.date),
            y: "percent",
            stroke: "steelblue",
            strokeWidth: 3,
            tip: true
          }
        ),
        Plot.rectY(
          anncsu_stats.map((d, i) => {
            // Per le variazioni, usa il total_all della data precedente
            const prev_total_all = i > 0 ? anncsu_stats[i - 1].total_all : d.total_all;
            return {
              date: d.date,
              percent: prev_total_all ? (d.new / prev_total_all) * 100 : 0
            };
          }),
          {
            x: d => new Date(d.date),
            y: "percent",
            fill: "green",
            interval: "2 days",
            tip: true
          }
        ),
        Plot.rectY(
          anncsu_stats.map((d, i) => {
            // Per le variazioni, usa il total_all della data precedente
            const prev_total_all = i > 0 ? anncsu_stats[i - 1].total_all : d.total_all;
            return {
              date: d.date,
              percent: prev_total_all ? -(d.missing / prev_total_all) * 100 : 0
            };
          }),
          {
            x: d => new Date(d.date),
            y: "percent",
            fill: "red",
            interval: "2 days",
            tip: true
          }
        ),
        Plot.ruleY([0])
      ]
    : [
        Plot.line(anncsu_stats, {
          x: d => new Date(d.date),
          y: "total",
          stroke: "steelblue",
          strokeWidth: 3,
          tip: true
        }),
        Plot.rectY(anncsu_stats, {
          x: d => new Date(d.date),
          y: "new",
          fill: "green",
          interval: "2 days",
          tip: true
        }),
        Plot.rectY(anncsu_stats, {
          x: d => new Date(d.date),
          y: d => -d.missing,
          fill: "red",
          interval: "2 days",
          tip: true
        }),
        Plot.ruleY([0])
      ],
  x: {
    type: "time",
    labelOffset: 40,
    label: "Data"
  },
  y: {
    grid: true,
    label: displayMode === "Percentuali" ? "% sul totale" : "Valori",
    tickFormat: displayMode === "Percentuali"
      ? d => `${d3.format(".1f")(d)}%`
      : d => d3.format(".1~s")(d).replace("G", "B")
  },
  color: {
    legend: true,
    domain: ["Totale", "Nuovi", "Rimossi"],
    range: ["steelblue", "green", "red"]
  }
})

))
}});

define({id: "79ef6f2a", inputs: ["Inputs","spatial_stats","SmartValue","displayMode","d3","display"], body: async (Inputs,spatial_stats,SmartValue,displayMode,d3,display) => {
display(await(
Inputs.table(
  (() => {
    const rows = spatial_stats.regioni.total.map(row => {
      const absolute_0903 = row["2025-09-03"] || 0;
      const absolute_1010 = row["2025-10-10"] || 0;
      const absolute_1104 = row["2025-11-04"] || 0;
      const absolute_1202 = row["2025-12-02"] || 0;

      const total_all_0903 = row["total_all_2025-09-03"] || 1;
      const total_all_1010 = row["total_all_2025-10-10"] || 1;
      const total_all_1104 = row["total_all_2025-11-04"] || 1;
      const total_all_1202 = row["total_all_2025-12-02"] || 1;

      const percent_0903 = (absolute_0903 / total_all_0903) * 100;
      const percent_1010 = (absolute_1010 / total_all_1010) * 100;
      const percent_1104 = (absolute_1104 / total_all_1104) * 100;
      const percent_1202 = (absolute_1202 / total_all_1202) * 100;

      return {
        regione: row.regione,
        "2025-09-03": new SmartValue(displayMode === "Percentuali" ? percent_0903 : absolute_0903, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_0903)}% (${d3.format(",")(absolute_0903)})`
          : `${d3.format(",")(absolute_0903)} (${d3.format(".2f")(percent_0903)}%)`),
        "2025-10-10": new SmartValue(displayMode === "Percentuali" ? percent_1010 : absolute_1010, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_1010)}% (${d3.format(",")(absolute_1010)})`
          : `${d3.format(",")(absolute_1010)} (${d3.format(".2f")(percent_1010)}%)`),
        "2025-11-04": new SmartValue(displayMode === "Percentuali" ? percent_1104 : absolute_1104, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_1104)}% (${d3.format(",")(absolute_1104)})`
          : `${d3.format(",")(absolute_1104)} (${d3.format(".2f")(percent_1104)}%)`),
        "2025-12-02": new SmartValue(displayMode === "Percentuali" ? percent_1202 : absolute_1202, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_1202)}% (${d3.format(",")(absolute_1202)})`
          : `${d3.format(",")(absolute_1202)} (${d3.format(".2f")(percent_1202)}%)`)
      };
    });

    return rows.sort((a, b) => b["2025-12-02"] - a["2025-12-02"]);
  })(),
  {
    columns: ["regione", "2025-09-03", "2025-10-10", "2025-11-04", "2025-12-02"],
    header: {
      regione: "Regione",
      "2025-09-03": "09/03",
      "2025-10-10": "10/10",
      "2025-11-04": "11/04",
      "2025-12-02": "12/02"
    }
  }
)
))
}});

define({id: "6116625d", inputs: ["view","Inputs","spatial_stats"], outputs: ["selected_date_region"], body: (view,Inputs,spatial_stats) => {
const selected_date_region = view(Inputs.select(
  spatial_stats.date_columns,
  {label: "Seleziona data", value: "2025-12-02"}
));
return {selected_date_region};
}});

define({id: "5433893c", inputs: ["Plot","selected_date_region","width","spatial_stats","display"], body: async (Plot,selected_date_region,width,spatial_stats,display) => {
display(await(
Plot.plot({
  title: `Distribuzione completamento per regione (${selected_date_region})`,
  width,
  height: 500,
  marginLeft: 120,
  marginBottom: 50,
  marks: [
    Plot.barX(
      spatial_stats.regioni.total
        .map(row => {
          const georef = row[selected_date_region] || 0;
          const total_all = row[`total_all_${selected_date_region}`] || 1;
          const percent = (georef / total_all) * 100;
          return {
            regione: row.regione,
            percent,
            georef,
            total_all
          };
        })
        .sort((a, b) => b.percent - a.percent),
      {
        y: "regione",
        x: "percent",
        fill: d => d.percent >= 99.9999 ? "#15a34a" : d.percent > 50 ? "#fbbf24" : "#ef4444",
        tip: true
      }
    ),
    Plot.ruleX([100], {stroke: "green", strokeDasharray: "4,4"})
  ],
  x: {
    label: "Completamento (%)",
    domain: [0, 100],
    grid: true
  },
  y: {
    label: null
  },
  color: {
    legend: true,
    domain: ["Completato (100%)", "In corso (>50%)", "Iniziale (≤50%)"],
    range: ["#15a34a", "#fbbf24", "#ef4444"]
  }
})
))
}});

define({id: "ae02f306", inputs: ["Inputs","spatial_stats","SmartValue","displayMode","d3","display"], body: async (Inputs,spatial_stats,SmartValue,displayMode,d3,display) => {
display(await(
Inputs.table(
  (() => {
    const rows = spatial_stats.regioni.new.map(row => {
      const totalRow = spatial_stats.regioni.total.find(r => r.regione === row.regione);

      const absolute_1010 = row["2025-10-10"] || 0;
      const absolute_1104 = row["2025-11-04"] || 0;
      const absolute_1202 = row["2025-12-02"] || 0;

      // Per le variazioni, usiamo il total_all della data precedente
      const total_all_0903 = totalRow?.["total_all_2025-09-03"] || 1;
      const total_all_1010 = totalRow?.["total_all_2025-10-10"] || 1;
      const total_all_1104 = totalRow?.["total_all_2025-11-04"] || 1;

      const percent_1010 = (absolute_1010 / total_all_0903) * 100;
      const percent_1104 = (absolute_1104 / total_all_1010) * 100;
      const percent_1202 = (absolute_1202 / total_all_1104) * 100;

      return {
        regione: row.regione,
        "2025-10-10": absolute_1010 ? new SmartValue(displayMode === "Percentuali" ? percent_1010 : absolute_1010, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_1010)}% (${d3.format(",")(absolute_1010)})`
          : `${d3.format(",")(absolute_1010)} (${d3.format(".2f")(percent_1010)}%)`) : new SmartValue(0, "0"),
        "2025-11-04": absolute_1104 ? new SmartValue(displayMode === "Percentuali" ? percent_1104 : absolute_1104, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_1104)}% (${d3.format(",")(absolute_1104)})`
          : `${d3.format(",")(absolute_1104)} (${d3.format(".2f")(percent_1104)}%)`) : new SmartValue(0, "0"),
        "2025-12-02": absolute_1202 ? new SmartValue(displayMode === "Percentuali" ? percent_1202 : absolute_1202, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_1202)}% (${d3.format(",")(absolute_1202)})`
          : `${d3.format(",")(absolute_1202)} (${d3.format(".2f")(percent_1202)}%)`) : new SmartValue(0, "0")
      };
    });

    return rows.sort((a, b) => {
      const valA = a["2025-12-02"] === "-" ? 0 : a["2025-12-02"].valueOf();
      const valB = b["2025-12-02"] === "-" ? 0 : b["2025-12-02"].valueOf();
      return valB - valA;
    });
  })(),
  {
    columns: ["regione", "2025-10-10", "2025-11-04", "2025-12-02"],
    header: {
      regione: "Regione",
      "2025-10-10": "10/10",
      "2025-11-04": "11/04",
      "2025-12-02": "12/02"
    }
  }
)
))
}});

define({id: "a8cbb7b0", inputs: ["Inputs","spatial_stats","SmartValue","displayMode","d3","display"], body: async (Inputs,spatial_stats,SmartValue,displayMode,d3,display) => {
display(await(
Inputs.table(
  (() => {
    const rows = spatial_stats.regioni.missing.map(row => {
      const totalRow = spatial_stats.regioni.total.find(r => r.regione === row.regione);

      const absolute_1010 = row["2025-10-10"] || 0;
      const absolute_1104 = row["2025-11-04"] || 0;
      const absolute_1202 = row["2025-12-02"] || 0;

      // Per le variazioni, usiamo il total_all della data precedente
      const total_all_0903 = totalRow?.["total_all_2025-09-03"] || 1;
      const total_all_1010 = totalRow?.["total_all_2025-10-10"] || 1;
      const total_all_1104 = totalRow?.["total_all_2025-11-04"] || 1;

      const percent_1010 = (absolute_1010 / total_all_0903) * 100;
      const percent_1104 = (absolute_1104 / total_all_1010) * 100;
      const percent_1202 = (absolute_1202 / total_all_1104) * 100;

      return {
        regione: row.regione,
        "2025-10-10": absolute_1010 ? new SmartValue(displayMode === "Percentuali" ? percent_1010 : absolute_1010, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_1010)}% (${d3.format(",")(absolute_1010)})`
          : `${d3.format(",")(absolute_1010)} (${d3.format(".2f")(percent_1010)}%)`) : new SmartValue(0, "0"),
        "2025-11-04": absolute_1104 ? new SmartValue(displayMode === "Percentuali" ? percent_1104 : absolute_1104, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_1104)}% (${d3.format(",")(absolute_1104)})`
          : `${d3.format(",")(absolute_1104)} (${d3.format(".2f")(percent_1104)}%)`) : new SmartValue(0, "0"),
        "2025-12-02": absolute_1202 ? new SmartValue(displayMode === "Percentuali" ? percent_1202 : absolute_1202, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_1202)}% (${d3.format(",")(absolute_1202)})`
          : `${d3.format(",")(absolute_1202)} (${d3.format(".2f")(percent_1202)}%)`) : new SmartValue(0, "0")
      };
    });

    return rows.sort((a, b) => {
      const valA = a["2025-12-02"] === "-" ? 0 : a["2025-12-02"].valueOf();
      const valB = b["2025-12-02"] === "-" ? 0 : b["2025-12-02"].valueOf();
      return valB - valA;
    });
  })(),
  {
    columns: ["regione", "2025-10-10", "2025-11-04", "2025-12-02"],
    header: {
      regione: "Regione",
      "2025-10-10": "10/10",
      "2025-11-04": "11/04",
      "2025-12-02": "12/02"
    }
  }
)
))
}});

define({id: "6797f3c9", inputs: ["view","Inputs","spatial_stats"], outputs: ["selected_region"], body: (view,Inputs,spatial_stats) => {
const selected_region = view(Inputs.select(
  spatial_stats.regioni.total.map(d => d.regione),
  {label: "Seleziona regione", value: "Liguria"}
));
return {selected_region};
}});

define({id: "fbdc2618", inputs: ["Plot","selected_region","width","displayMode","spatial_stats","d3","display"], body: async (Plot,selected_region,width,displayMode,spatial_stats,d3,display) => {
display(await(
Plot.plot({
  title: `Variazioni ANNCSU in ${selected_region}`,
  width,
  marginLeft: 60,
  marginBottom: 50,
  marks: displayMode === "Percentuali"
    ? [
        Plot.barY(
          spatial_stats.date_columns
            .filter(d => d !== "2025-09-03")
            .flatMap((date, idx) => {
              const region_data = spatial_stats.regioni.total.find(d => d.regione === selected_region);
              // Per le variazioni, usa il total_all della data precedente
              const prev_date = spatial_stats.date_columns[idx];  // idx parte da 0 dopo il filter
              const total_all_prev = region_data?.[`total_all_${prev_date}`] || 1;

              const new_count = spatial_stats.regioni.new.find(d => d.regione === selected_region)?.[date] || 0;
              const missing_count = spatial_stats.regioni.missing.find(d => d.regione === selected_region)?.[date] || 0;
              const moved_count = spatial_stats.regioni.moved.find(d => d.regione === selected_region)?.[date] || 0;

              const bars = [];
              if (new_count > 0) bars.push({date: new Date(date), tipo: "Nuovi", percent: (new_count / total_all_prev) * 100});
              if (missing_count > 0) bars.push({date: new Date(date), tipo: "Rimossi", percent: -(missing_count / total_all_prev) * 100});
              if (moved_count > 0) bars.push({date: new Date(date), tipo: "Spostati", percent: (moved_count / total_all_prev) * 100});
              return bars;
            }),
          {
            x: "date",
            y: "percent",
            fill: "tipo",
            tip: true,
            dx: d => d.tipo === "Nuovi" ? -8 : d.tipo === "Spostati" ? 8 : 0
          }
        ),
        Plot.lineY(
          spatial_stats.date_columns
            .filter(d => d !== "2025-09-03")
            .map(date => {
              const region_data = spatial_stats.regioni.total.find(d => d.regione === selected_region);
              const total = region_data?.[date] || 0;
              const total_all = region_data?.[`total_all_${date}`] || 1;
              return {date: new Date(date), percent: (total / total_all) * 100};
            }),
          {
            x: "date",
            y: "percent",
            stroke: "black",
            strokeWidth: 2,
            marker: "circle",
            tip: true
          }
        ),
        Plot.ruleY([0])
      ]
    : [
        Plot.barY(
          spatial_stats.date_columns
            .filter(d => d !== "2025-09-03")
            .flatMap(date => {
              const new_count = spatial_stats.regioni.new.find(d => d.regione === selected_region)?.[date] || 0;
              const missing_count = spatial_stats.regioni.missing.find(d => d.regione === selected_region)?.[date] || 0;
              const moved_count = spatial_stats.regioni.moved.find(d => d.regione === selected_region)?.[date] || 0;

              const bars = [];
              if (new_count > 0) bars.push({date: new Date(date), tipo: "Nuovi", count: new_count});
              if (missing_count > 0) bars.push({date: new Date(date), tipo: "Rimossi", count: -missing_count});
              if (moved_count > 0) bars.push({date: new Date(date), tipo: "Spostati", count: moved_count});
              return bars;
            }),
          {
            x: "date",
            y: "count",
            fill: "tipo",
            tip: true,
            dx: d => d.tipo === "Nuovi" ? -8 : d.tipo === "Spostati" ? 8 : 0
          }
        ),
        Plot.lineY(
          spatial_stats.date_columns
            .filter(d => d !== "2025-09-03")
            .map(date => {
              const region_data = spatial_stats.regioni.total.find(d => d.regione === selected_region);
              return {date: new Date(date), total: region_data?.[date] || 0};
            }),
          {
            x: "date",
            y: "total",
            stroke: "black",
            strokeWidth: 2,
            marker: "circle",
            tip: true
          }
        ),
        Plot.ruleY([0])
      ],
  x: {
    label: "Data",
    labelOffset: 35
  },
  y: {
    grid: true,
    label: displayMode === "Percentuali" ? "% sul totale" : "Numero civici",
    tickFormat: displayMode === "Percentuali"
      ? d => `${d3.format(".1f")(d)}%`
      : d => d3.format("~s")(d)
  },
  color: {
    legend: true,
    domain: ["Nuovi", "Rimossi", "Spostati"],
    range: ["#0066ff", "#e60026", "#15a34a"]
  }
})
))
}});

define({id: "423b6aa6", inputs: ["Inputs","spatial_stats","SmartValue","displayMode","d3","display"], body: async (Inputs,spatial_stats,SmartValue,displayMode,d3,display) => {
display(await(
Inputs.table(
  (() => {
    const rows = spatial_stats.comuni.total.map(row => {
      const absolute_0903 = row["2025-09-03"] || 0;
      const absolute_1010 = row["2025-10-10"] || 0;
      const absolute_1104 = row["2025-11-04"] || 0;
      const absolute_1202 = row["2025-12-02"] || 0;

      const total_all_0903 = row["total_all_2025-09-03"] || 1;
      const total_all_1010 = row["total_all_2025-10-10"] || 1;
      const total_all_1104 = row["total_all_2025-11-04"] || 1;
      const total_all_1202 = row["total_all_2025-12-02"] || 1;

      const percent_0903 = (absolute_0903 / total_all_0903) * 100;
      const percent_1010 = (absolute_1010 / total_all_1010) * 100;
      const percent_1104 = (absolute_1104 / total_all_1104) * 100;
      const percent_1202 = (absolute_1202 / total_all_1202) * 100;

      return {
        comune: row.comune,
        "2025-09-03": new SmartValue(displayMode === "Percentuali" ? percent_0903 : absolute_0903, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_0903)}% (${d3.format(",")(absolute_0903)})`
          : `${d3.format(",")(absolute_0903)} (${d3.format(".2f")(percent_0903)}%)`),
        "2025-10-10": new SmartValue(displayMode === "Percentuali" ? percent_1010 : absolute_1010, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_1010)}% (${d3.format(",")(absolute_1010)})`
          : `${d3.format(",")(absolute_1010)} (${d3.format(".2f")(percent_1010)}%)`),
        "2025-11-04": new SmartValue(displayMode === "Percentuali" ? percent_1104 : absolute_1104, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_1104)}% (${d3.format(",")(absolute_1104)})`
          : `${d3.format(",")(absolute_1104)} (${d3.format(".2f")(percent_1104)}%)`),
        "2025-12-02": new SmartValue(displayMode === "Percentuali" ? percent_1202 : absolute_1202, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_1202)}% (${d3.format(",")(absolute_1202)})`
          : `${d3.format(",")(absolute_1202)} (${d3.format(".2f")(percent_1202)}%)`)
      };
    });

    return rows.sort((a, b) => b["2025-12-02"] - a["2025-12-02"]);
  })(),
  {
    columns: ["comune", "2025-09-03", "2025-10-10", "2025-11-04", "2025-12-02"],
    header: {
      comune: "Comune",
      "2025-09-03": "09/03",
      "2025-10-10": "10/10",
      "2025-11-04": "11/04",
      "2025-12-02": "12/02"
    }
  }
)
))
}});

define({id: "ccb3ac95", inputs: ["view","Inputs","spatial_stats"], outputs: ["selected_date_comune"], body: (view,Inputs,spatial_stats) => {
const selected_date_comune = view(Inputs.select(
  spatial_stats.date_columns,
  {label: "Seleziona data", value: "2025-12-02"}
));
return {selected_date_comune};
}});

define({id: "a26800f2", inputs: ["view","Inputs","spatial_stats"], outputs: ["filter_region_dist"], body: (view,Inputs,spatial_stats) => {
const filter_region_dist = view(Inputs.select(
  ["Tutte"].concat(spatial_stats.regioni.total.map(d => d.regione)),
  {label: "Filtra per regione", value: "Tutte"}
));
return {filter_region_dist};
}});

define({id: "854ba575", inputs: ["spatial_stats","filter_region_dist","selected_date_comune","Plot","width","display"], body: async (spatial_stats,filter_region_dist,selected_date_comune,Plot,width,display) => {
display(await(
(() => {
  // Prepara i dati pre-binnati
  const comuni_data = spatial_stats.comuni.total
    .filter(row => filter_region_dist === "Tutte" || row.regione === filter_region_dist)
    .map(row => {
      const georef = row[selected_date_comune] || 0;
      const total_all = row[`total_all_${selected_date_comune}`] || 1;
      const percent = (georef / total_all) * 100;
      return percent;
    });

  // Crea i bin manualmente
  const bins = [];
  for (let i = 0; i < 95; i += 5) {
    const count = comuni_data.filter(p => p >= i && p < i + 5).length;
    if (count > 0) {
      bins.push({
        x: i + 2.5,  // centro del bin
        x1: i,
        x2: i + 5,
        y: count,
        categoria: i >= 50 ? "In corso (>50%)" : "Iniziale (≤50%)",
        completamento: `${i}-${i + 5}%`
      });
    }
  }

  // Bin 95-99.9999 (giallo)
  const count95 = comuni_data.filter(p => p >= 95 && p < 99.9999).length;
  if (count95 > 0) {
    bins.push({
      x: 97.5,
      x1: 95,
      x2: 100,
      y: count95,
      categoria: "In corso (>50%)",
      completamento: "95-100%"
    });
  }

  // Bin 100% esatto (verde)
  const count100 = comuni_data.filter(p => p >= 99.9999).length;
  if (count100 > 0) {
    bins.push({
      x: 100,
      x1: 100,
      x2: 105,
      y: count100,
      categoria: "Completato (100%)",
      completamento: "100%"
    });
  }

  return Plot.plot({
    title: `Distribuzione completamento comuni ${filter_region_dist !== "Tutte" ? `(${filter_region_dist})` : ""} - ${selected_date_comune}`,
    width,
    height: 400,
    marginLeft: 60,
    marginBottom: 60,
    marks: [
      Plot.rectY(bins, {
        x1: "x1",
        x2: "x2",
        y: "y",
        fill: d => d.categoria === "Completato (100%)" ? "#15a34a" :
                   d.categoria === "In corso (>50%)" ? "#fbbf24" : "#ef4444",
        channels: {completamento: "completamento"},
        tip: {
          format: {
            x1: false,
            x2: false,
            completamento: true
          }
        }
      }),
      Plot.ruleX([100], {stroke: "green", strokeWidth: 2, strokeDasharray: "4,4"})
    ],
    x: {
      label: "Completamento (%)",
      labelOffset: 40,
      domain: [0, 105],
      grid: true
    },
    y: {
      label: "Numero comuni",
      grid: true
    },
    color: {
      legend: true,
      domain: ["Completato (100%)", "In corso (>50%)", "Iniziale (≤50%)"],
      range: ["#15a34a", "#fbbf24", "#ef4444"]
    }
  });
})()
))
}});

define({id: "ac11cc28", inputs: ["Inputs","spatial_stats","SmartValue","displayMode","d3","display"], body: async (Inputs,spatial_stats,SmartValue,displayMode,d3,display) => {
display(await(
Inputs.table(
  (() => {
    const rows = spatial_stats.comuni.new.map(row => {
      const totalRow = spatial_stats.comuni.total.find(r => r.comune === row.comune);

      const absolute_1010 = row["2025-10-10"] || 0;
      const absolute_1104 = row["2025-11-04"] || 0;
      const absolute_1202 = row["2025-12-02"] || 0;

      // Per le variazioni, usiamo il total_all della data precedente
      const total_all_0903 = totalRow?.["total_all_2025-09-03"] || 1;
      const total_all_1010 = totalRow?.["total_all_2025-10-10"] || 1;
      const total_all_1104 = totalRow?.["total_all_2025-11-04"] || 1;

      const percent_1010 = (absolute_1010 / total_all_0903) * 100;
      const percent_1104 = (absolute_1104 / total_all_1010) * 100;
      const percent_1202 = (absolute_1202 / total_all_1104) * 100;

      return {
        comune: row.comune,
        "2025-10-10": absolute_1010 ? new SmartValue(displayMode === "Percentuali" ? percent_1010 : absolute_1010, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_1010)}% (${d3.format(",")(absolute_1010)})`
          : `${d3.format(",")(absolute_1010)} (${d3.format(".2f")(percent_1010)}%)`) : new SmartValue(0, "0"),
        "2025-11-04": absolute_1104 ? new SmartValue(displayMode === "Percentuali" ? percent_1104 : absolute_1104, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_1104)}% (${d3.format(",")(absolute_1104)})`
          : `${d3.format(",")(absolute_1104)} (${d3.format(".2f")(percent_1104)}%)`) : new SmartValue(0, "0"),
        "2025-12-02": absolute_1202 ? new SmartValue(displayMode === "Percentuali" ? percent_1202 : absolute_1202, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_1202)}% (${d3.format(",")(absolute_1202)})`
          : `${d3.format(",")(absolute_1202)} (${d3.format(".2f")(percent_1202)}%)`) : new SmartValue(0, "0")
      };
    });

    return rows.sort((a, b) => {
      const valA = a["2025-12-02"].valueOf();
      const valB = b["2025-12-02"].valueOf();
      return valB - valA;
    });
  })(),
  {
    columns: ["comune", "2025-10-10", "2025-11-04", "2025-12-02"],
    header: {
      comune: "Comune",
      "2025-10-10": "10/10",
      "2025-11-04": "11/04",
      "2025-12-02": "12/02"
    }
  }
)
))
}});

define({id: "c647ac42", inputs: ["Inputs","spatial_stats","SmartValue","displayMode","d3","display"], body: async (Inputs,spatial_stats,SmartValue,displayMode,d3,display) => {
display(await(
Inputs.table(
  (() => {
    const rows = spatial_stats.comuni.missing.map(row => {
      const totalRow = spatial_stats.comuni.total.find(r => r.comune === row.comune);

      const absolute_1010 = row["2025-10-10"] || 0;
      const absolute_1104 = row["2025-11-04"] || 0;
      const absolute_1202 = row["2025-12-02"] || 0;

      // Per le variazioni, usiamo il total_all della data precedente
      const total_all_0903 = totalRow?.["total_all_2025-09-03"] || 1;
      const total_all_1010 = totalRow?.["total_all_2025-10-10"] || 1;
      const total_all_1104 = totalRow?.["total_all_2025-11-04"] || 1;

      const percent_1010 = (absolute_1010 / total_all_0903) * 100;
      const percent_1104 = (absolute_1104 / total_all_1010) * 100;
      const percent_1202 = (absolute_1202 / total_all_1104) * 100;

      return {
        comune: row.comune,
        "2025-10-10": absolute_1010 ? new SmartValue(displayMode === "Percentuali" ? percent_1010 : absolute_1010, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_1010)}% (${d3.format(",")(absolute_1010)})`
          : `${d3.format(",")(absolute_1010)} (${d3.format(".2f")(percent_1010)}%)`) : new SmartValue(0, "0"),
        "2025-11-04": absolute_1104 ? new SmartValue(displayMode === "Percentuali" ? percent_1104 : absolute_1104, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_1104)}% (${d3.format(",")(absolute_1104)})`
          : `${d3.format(",")(absolute_1104)} (${d3.format(".2f")(percent_1104)}%)`) : new SmartValue(0, "0"),
        "2025-12-02": absolute_1202 ? new SmartValue(displayMode === "Percentuali" ? percent_1202 : absolute_1202, displayMode === "Percentuali"
          ? `${d3.format(".2f")(percent_1202)}% (${d3.format(",")(absolute_1202)})`
          : `${d3.format(",")(absolute_1202)} (${d3.format(".2f")(percent_1202)}%)`) : new SmartValue(0, "0")
      };
    });

    return rows.sort((a, b) => {
      const valA = a["2025-12-02"].valueOf();
      const valB = b["2025-12-02"].valueOf();
      return valB - valA;
    });
  })(),
  {
    columns: ["comune", "2025-10-10", "2025-11-04", "2025-12-02"],
    header: {
      comune: "Comune",
      "2025-10-10": "10/10",
      "2025-11-04": "11/04",
      "2025-12-02": "12/02"
    }
  }
)
))
}});

define({id: "fa073e0d", inputs: ["view","Inputs","spatial_stats"], outputs: ["filter_region"], body: (view,Inputs,spatial_stats) => {
const filter_region = view(Inputs.select(
  spatial_stats.regioni.total.map(d => d.regione),
  {label: "Filtra per regione", value: "Liguria"}
));
return {filter_region};
}});

define({id: "2ef2300c", inputs: ["spatial_stats","filter_region","view","Inputs"], outputs: ["filtered_comuni","selected_municipality"], body: (spatial_stats,filter_region,view,Inputs) => {
// Per filtrare i comuni per regione, usiamo la proprietà regione presente nei dati
const filtered_comuni = spatial_stats.comuni.total
  .filter(d => d.regione === filter_region)
  .map(d => d.comune)
  .sort((a, b) => a.localeCompare(b, 'it'));

const selected_municipality = view(Inputs.select(
  filtered_comuni,
  {label: "Seleziona comune", value: filtered_comuni[0]}
));
return {filtered_comuni,selected_municipality};
}});

define({id: "f156abe9", inputs: ["Plot","selected_municipality","width","displayMode","spatial_stats","d3","display"], body: async (Plot,selected_municipality,width,displayMode,spatial_stats,d3,display) => {
display(await(
Plot.plot({
  title: `Variazioni ANNCSU a ${selected_municipality}`,
  width,
  marginLeft: 60,
  marginBottom: 50,
  marks: displayMode === "Percentuali"
    ? [
        Plot.barY(
          spatial_stats.date_columns
            .filter(d => d !== "2025-09-03")
            .flatMap((date, idx) => {
              const municipality_data = spatial_stats.comuni.total.find(d => d.comune === selected_municipality);
              // Per le variazioni, usa il total_all della data precedente
              const prev_date = spatial_stats.date_columns[idx];  // idx parte da 0 dopo il filter
              const total_all_prev = municipality_data?.[`total_all_${prev_date}`] || 1;

              const new_count = spatial_stats.comuni.new.find(d => d.comune === selected_municipality)?.[date] || 0;
              const missing_count = spatial_stats.comuni.missing.find(d => d.comune === selected_municipality)?.[date] || 0;
              const moved_count = spatial_stats.comuni.moved.find(d => d.comune === selected_municipality)?.[date] || 0;

              const bars = [];
              if (new_count > 0) bars.push({date: new Date(date), tipo: "Nuovi", percent: (new_count / total_all_prev) * 100});
              if (missing_count > 0) bars.push({date: new Date(date), tipo: "Rimossi", percent: -(missing_count / total_all_prev) * 100});
              if (moved_count > 0) bars.push({date: new Date(date), tipo: "Spostati", percent: (moved_count / total_all_prev) * 100});
              return bars;
            }),
          {
            x: "date",
            y: "percent",
            fill: "tipo",
            tip: true,
            dx: d => d.tipo === "Nuovi" ? -8 : d.tipo === "Spostati" ? 8 : 0
          }
        ),
        Plot.lineY(
          spatial_stats.date_columns
            .filter(d => d !== "2025-09-03")
            .map(date => {
              const municipality_data = spatial_stats.comuni.total.find(d => d.comune === selected_municipality);
              const total = municipality_data?.[date] || 0;
              const total_all = municipality_data?.[`total_all_${date}`] || 1;
              return {date: new Date(date), percent: (total / total_all) * 100};
            }),
          {
            x: "date",
            y: "percent",
            stroke: "black",
            strokeWidth: 2,
            marker: "circle",
            tip: true
          }
        ),
        Plot.ruleY([0])
      ]
    : [
        Plot.barY(
          spatial_stats.date_columns
            .filter(d => d !== "2025-09-03")
            .flatMap(date => {
              const new_count = spatial_stats.comuni.new.find(d => d.comune === selected_municipality)?.[date] || 0;
              const missing_count = spatial_stats.comuni.missing.find(d => d.comune === selected_municipality)?.[date] || 0;
              const moved_count = spatial_stats.comuni.moved.find(d => d.comune === selected_municipality)?.[date] || 0;

              const bars = [];
              if (new_count > 0) bars.push({date: new Date(date), tipo: "Nuovi", count: new_count});
              if (missing_count > 0) bars.push({date: new Date(date), tipo: "Rimossi", count: -missing_count});
              if (moved_count > 0) bars.push({date: new Date(date), tipo: "Spostati", count: moved_count});
              return bars;
            }),
          {
            x: "date",
            y: "count",
            fill: "tipo",
            tip: true,
            dx: d => d.tipo === "Nuovi" ? -8 : d.tipo === "Spostati" ? 8 : 0
          }
        ),
        Plot.lineY(
          spatial_stats.date_columns
            .filter(d => d !== "2025-09-03")
            .map(date => {
              const municipality_data = spatial_stats.comuni.total.find(d => d.comune === selected_municipality);
              return {date: new Date(date), total: municipality_data?.[date] || 0};
            }),
          {
            x: "date",
            y: "total",
            stroke: "black",
            strokeWidth: 2,
            marker: "circle",
            tip: true
          }
        ),
        Plot.ruleY([0])
      ],
  x: {
    label: "Data",
    labelOffset: 35
  },
  y: {
    grid: true,
    label: displayMode === "Percentuali" ? "% sul totale" : "Numero civici",
    tickFormat: displayMode === "Percentuali"
      ? d => `${d3.format(".1f")(d)}%`
      : d => d3.format("~s")(d)
  },
  color: {
    legend: true,
    domain: ["Nuovi", "Rimossi", "Spostati"],
    range: ["#0066ff", "#e60026", "#15a34a"]
  }
})
))
}});

</script>
</head>
<body>
<div id="observablehq-center">
<aside id="observablehq-toc" data-selector="h1:not(:first-of-type)[id], h2:first-child[id], :not(h1) + h2[id]">
<nav>
<div>Contents</div>
<ol>
<li class="observablehq-secondary-link"><a href="#andamento-civici-geolocalizzati">Andamento civici geolocalizzati</a></li>
<li class="observablehq-secondary-link"><a href="#statistiche-regionali">Statistiche Regionali</a></li>
<li class="observablehq-secondary-link"><a href="#statistiche-comunali">Statistiche Comunali</a></li>
</ol>
</nav>
</aside>
<main id="observablehq-main" class="observablehq">
<h1 id="andamento-anncsu" tabindex="-1"><a class="observablehq-header-anchor" href="#andamento-anncsu">Andamento ANNCSU</a></h1>
<p>Analisi dell'evoluzione della geolocalizzazione dei numeri civici di ANNCSU basata sui dati scaricabili da <a href="https://www.anncsu.gov.it/it/consultazione-dellarchivio/open-data/Accedi-ai-servizi-di-dowload-massivo-in-Open-data/" target="_blank" rel="noopener noreferrer">https://www.anncsu.gov.it/it/consultazione-dellarchivio/open-data/Accedi-ai-servizi-di-dowload-massivo-in-Open-data/</a></p>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:2293e18f:--></div>
<div class="observablehq observablehq--block"><!--:4bcc7d2b:--></div>
<div class="observablehq observablehq--block"><!--:a28d0326:--></div>
<div class="observablehq observablehq--block"><!--:cd7947f4:--></div>
<div class="observablehq observablehq--block"><!--:a28d2edd:--></div>
<div class="observablehq observablehq--block"><!--:3497237d:--></div>
<h2 id="andamento-civici-geolocalizzati" tabindex="-1"><a class="observablehq-header-anchor" href="#andamento-civici-geolocalizzati">Andamento civici geolocalizzati</a></h2>
<div class="observablehq observablehq--block"><!--:d3c01a2f:--></div>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:6e74da5a:--></div>
<hr>
<h2 id="statistiche-regionali" tabindex="-1"><a class="observablehq-header-anchor" href="#statistiche-regionali">Statistiche Regionali</a></h2>
<h3 id="civici-georeferenziati-per-regione" tabindex="-1"><a class="observablehq-header-anchor" href="#civici-georeferenziati-per-regione">Civici Georeferenziati per Regione</a></h3>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:79ef6f2a:--></div>
<h3 id="distribuzione-completamento-regioni" tabindex="-1"><a class="observablehq-header-anchor" href="#distribuzione-completamento-regioni">Distribuzione Completamento Regioni</a></h3>
<div class="observablehq observablehq--block"><!--:6116625d:--></div>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:5433893c:--></div>
<h3 id="nuovi-civici-per-regione" tabindex="-1"><a class="observablehq-header-anchor" href="#nuovi-civici-per-regione">Nuovi Civici per Regione</a></h3>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:ae02f306:--></div>
<h3 id="civici-rimossi-per-regione" tabindex="-1"><a class="observablehq-header-anchor" href="#civici-rimossi-per-regione">Civici Rimossi per Regione</a></h3>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:a8cbb7b0:--></div>
<h3 id="grafico-variazioni-per-regione" tabindex="-1"><a class="observablehq-header-anchor" href="#grafico-variazioni-per-regione">Grafico Variazioni per Regione</a></h3>
<div class="observablehq observablehq--block"><!--:6797f3c9:--></div>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:fbdc2618:--></div>
<hr>
<h2 id="statistiche-comunali" tabindex="-1"><a class="observablehq-header-anchor" href="#statistiche-comunali">Statistiche Comunali</a></h2>
<h3 id="civici-georeferenziati-per-comune" tabindex="-1"><a class="observablehq-header-anchor" href="#civici-georeferenziati-per-comune">Civici Georeferenziati per Comune</a></h3>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:423b6aa6:--></div>
<h3 id="distribuzione-completamento-comuni" tabindex="-1"><a class="observablehq-header-anchor" href="#distribuzione-completamento-comuni">Distribuzione Completamento Comuni</a></h3>
<div class="observablehq observablehq--block"><!--:ccb3ac95:--></div>
<div class="observablehq observablehq--block"><!--:a26800f2:--></div>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:854ba575:--></div>
<h3 id="nuovi-civici-per-comune" tabindex="-1"><a class="observablehq-header-anchor" href="#nuovi-civici-per-comune">Nuovi Civici per Comune</a></h3>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:ac11cc28:--></div>
<h3 id="civici-rimossi-per-comune" tabindex="-1"><a class="observablehq-header-anchor" href="#civici-rimossi-per-comune">Civici Rimossi per Comune</a></h3>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:c647ac42:--></div>
<h3 id="grafico-variazioni-per-comune" tabindex="-1"><a class="observablehq-header-anchor" href="#grafico-variazioni-per-comune">Grafico Variazioni per Comune</a></h3>
<div class="observablehq observablehq--block"><!--:fa073e0d:--></div>
<div class="observablehq observablehq--block"><!--:2ef2300c:--></div>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:f156abe9:--></div>
</main>
<footer id="observablehq-footer">
<div>Built with <a href="https://observablehq.com/" target="_blank" rel="noopener noreferrer">Observable</a> on <a title="2025-12-12T10:32:59">Dec 12, 2025</a>.</div>
</footer>
</div>
</body>
</html>
