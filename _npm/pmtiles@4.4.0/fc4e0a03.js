/**
 * Bundled by jsDelivr using Rollup v2.79.2 and Terser v5.39.0.
 * Original file: /npm/pmtiles@4.4.0/dist/esm/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{decompressSync as e}from"../fflate@0.8.2/e113a0e7.js";var t=Object.defineProperty,r=Math.pow,i=(e,r)=>t(e,"name",{value:r,configurable:!0}),n=(e,t,r)=>new Promise(((i,n)=>{var s=e=>{try{a(r.next(e))}catch(e){n(e)}},o=e=>{try{a(r.throw(e))}catch(e){n(e)}},a=e=>e.done?i(e.value):Promise.resolve(e.value).then(s,o);a((r=r.apply(e,t)).next())})),s=i(((e,t)=>{let r=!1,n="";return new(L.GridLayer.extend({createTile:i(((t,i)=>{let s=document.createElement("img"),o=new AbortController,a=o.signal;return s.cancel=()=>{o.abort()},r||(e.getHeader().then((e=>{1===e.tileType?console.error("Error: archive contains MVT vector tiles, but leafletRasterLayer is for displaying raster tiles. See https://github.com/protomaps/PMTiles/tree/main/js for details."):2===e.tileType?n="image/png":3===e.tileType?n="image/jpeg":4===e.tileType?n="image/webp":5===e.tileType&&(n="image/avif")})),r=!0),e.getZxy(t.z,t.x,t.y,a).then((e=>{if(e){let t=new Blob([e.data],{type:n}),r=window.URL.createObjectURL(t);s.src=r}else s.style.display="none";s.cancel=void 0,i(void 0,s)})).catch((e=>{if("AbortError"!==e.name)throw e})),s}),"createTile"),_removeTile:i((function(e){let t=this._tiles[e];t&&(t.el.cancel&&t.el.cancel(),t.el.width=0,t.el.height=0,t.el.deleted=!0,L.DomUtil.remove(t.el),delete this._tiles[e],this.fire("tileunload",{tile:t.el,coords:this._keyToTileCoords(e)}))}),"_removeTile")}))(t)}),"leafletRasterLayer"),o=i((e=>(t,r)=>{if(r instanceof AbortController)return e(t,r);let n=new AbortController;return e(t,n).then((e=>r(void 0,e.data,e.cacheControl||"",e.expires||"")),(e=>r(e))).catch((e=>r(e))),{cancel:i((()=>n.abort()),"cancel")}}),"v3compat"),a=class{constructor(e){this.tilev4=i(((e,t)=>n(this,null,(function*(){if("json"===e.type){let r=e.url.substr(10),i=this.tiles.get(r);if(i||(i=new j(r),this.tiles.set(r,i)),this.metadata){let r=yield i.getTileJson(e.url);return t.signal.throwIfAborted(),{data:r}}let n=yield i.getHeader();return t.signal.throwIfAborted(),(n.minLon>=n.maxLon||n.minLat>=n.maxLat)&&console.error(`Bounds of PMTiles archive ${n.minLon},${n.minLat},${n.maxLon},${n.maxLat} are not valid.`),{data:{tiles:[`${e.url}/{z}/{x}/{y}`],minzoom:n.minZoom,maxzoom:n.maxZoom,bounds:[n.minLon,n.minLat,n.maxLon,n.maxLat]}}}let r=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),i=e.url.match(r);if(!i)throw new Error("Invalid PMTiles protocol URL");let n=i[1],s=this.tiles.get(n);s||(s=new j(n),this.tiles.set(n,s));let o=i[2],a=i[3],l=i[4],c=yield s.getHeader(),h=yield null==s?void 0:s.getZxy(+o,+a,+l,t.signal);if(t.signal.throwIfAborted(),h)return{data:new Uint8Array(h.data),cacheControl:h.cacheControl,expires:h.expires};if(1===c.tileType){if(this.errorOnMissingTile)throw new Error("Tile not found.");return{data:new Uint8Array}}return{data:null}}))),"tilev4"),this.tile=o(this.tilev4),this.tiles=new Map,this.metadata=(null==e?void 0:e.metadata)||!1,this.errorOnMissingTile=(null==e?void 0:e.errorOnMissingTile)||!1}add(e){this.tiles.set(e.source.getKey(),e)}get(e){return this.tiles.get(e)}};i(a,"Protocol");var l=a;function c(e,t){return 4294967296*(t>>>0)+(e>>>0)}function h(e,t){let r=t.buf,i=r[t.pos++],n=(112&i)>>4;if(i<128||(i=r[t.pos++],n|=(127&i)<<3,i<128)||(i=r[t.pos++],n|=(127&i)<<10,i<128)||(i=r[t.pos++],n|=(127&i)<<17,i<128)||(i=r[t.pos++],n|=(127&i)<<24,i<128)||(i=r[t.pos++],n|=(1&i)<<31,i<128))return c(e,n);throw new Error("Expected varint not more than 10 bytes")}function d(e){let t=e.buf,r=t[e.pos++],i=127&r;return r<128||(r=t[e.pos++],i|=(127&r)<<7,r<128)||(r=t[e.pos++],i|=(127&r)<<14,r<128)||(r=t[e.pos++],i|=(127&r)<<21,r<128)?i:(r=t[e.pos],i|=(15&r)<<28,h(i,e))}function u(e,t,r,i,n){return 0===n?0!==i?[e-1-r,e-1-t]:[r,t]:[t,r]}function f(e,t,r){if(e>26)throw new Error("Tile zoom level exceeds max safe number limit (26)");if(t>=1<<e||r>=1<<e)throw new Error("tile x/y outside zoom level bounds");let i=((1<<e)*(1<<e)-1)/3,n=e-1,[s,o]=[t,r];for(let e=1<<n;e>0;e>>=1){let t=s&e,r=o&e;i+=(3*t^r)*(1<<n),[s,o]=u(e,s,o,t,r),n--}return i}function g(e){let t=3*e+1;return t<4294967296?31-Math.clz32(t):63-Math.clz32(t/4294967296)}function m(e){let t=g(e)>>1;if(t>26)throw new Error("Tile zoom level exceeds max safe number limit (26)");let r=e-((1<<t)*(1<<t)-1)/3,i=0,n=0,s=1<<t;for(let e=1;e<s;e<<=1){let t=e&r/2,s=e&(r^t);[i,n]=u(e,i,n,t,s),r/=2,i+=t,n+=s}return[t,i,n]}i(c,"toNum"),i(h,"readVarintRemainder"),i(d,"readVarint"),i(u,"rotate"),i(f,"zxyToTileId"),i(g,"tileIdToZ"),i(m,"tileIdToZxy");var y,p=((y=p||{})[y.Unknown=0]="Unknown",y[y.None=1]="None",y[y.Gzip=2]="Gzip",y[y.Brotli=3]="Brotli",y[y.Zstd=4]="Zstd",y);function w(t,r){return n(this,null,(function*(){if(1===r||0===r)return t;if(2===r){if(void 0===globalThis.DecompressionStream)return e(new Uint8Array(t));let r=new Response(t).body;if(!r)throw new Error("Failed to read response stream");let i=r.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(i).arrayBuffer()}throw new Error("Compression method not supported")}))}i(w,"defaultDecompress");var v,x=((v=x||{})[v.Unknown=0]="Unknown",v[v.Mvt=1]="Mvt",v[v.Png=2]="Png",v[v.Jpeg=3]="Jpeg",v[v.Webp=4]="Webp",v[v.Avif=5]="Avif",v[v.Mlt=6]="Mlt",v);function T(e){return 1===e?".mvt":2===e?".png":3===e?".jpg":4===e?".webp":5===e?".avif":6===e?".mlt":""}i(T,"tileTypeExt");function b(e,t){let r=0,i=e.length-1;for(;r<=i;){let n=i+r>>1,s=t-e[n].tileId;if(s>0)r=n+1;else{if(!(s<0))return e[n];i=n-1}}return i>=0&&(0===e[i].runLength||t-e[i].tileId<e[i].runLength)?e[i]:null}i(b,"findTile");var C=class{constructor(e){this.file=e}getKey(){return this.file.name}getBytes(e,t){return n(this,null,(function*(){return{data:yield this.file.slice(e,e+t).arrayBuffer()}}))}};i(C,"FileSource");var U=C,E=class{constructor(e,t=new Headers){var r,i;this.url=e,this.customHeaders=t,this.mustReload=!1;let n="";"navigator"in globalThis&&(n=null!=(i=null==(r=globalThis.navigator)?void 0:r.userAgent)?i:"");let s=n.indexOf("Windows")>-1,o=/Chrome|Chromium|Edg|OPR|Brave/.test(n);this.chromeWindowsNoCache=!1,s&&o&&(this.chromeWindowsNoCache=!0)}getKey(){return this.url}setHeaders(e){this.customHeaders=e}getBytes(e,t,r,i){return n(this,null,(function*(){let n,s;r?s=r:(n=new AbortController,s=n.signal);let o,a=new Headers(this.customHeaders);a.set("range",`bytes=${e}-${e+t-1}`),this.mustReload?o="reload":this.chromeWindowsNoCache&&(o="no-store");let l=yield fetch(this.url,{signal:s,cache:o,headers:a});if(0===e&&416===l.status){let e=l.headers.get("Content-Range");if(!e||!e.startsWith("bytes */"))throw new Error("Missing content-length on 416 response");let t=+e.substr(8);l=yield fetch(this.url,{signal:s,cache:"reload",headers:{range:"bytes=0-"+(t-1)}})}let c=l.headers.get("Etag");if(null!=c&&c.startsWith("W/")&&(c=null),416===l.status||i&&c&&c!==i)throw this.mustReload=!0,new H(`Server returned non-matching ETag ${i} after one retry. Check browser extensions and servers for issues that may affect correct ETag headers.`);if(l.status>=300)throw new Error(`Bad response code: ${l.status}`);let h=l.headers.get("Content-Length");if(200===l.status&&(!h||+h>t))throw n&&n.abort(),new Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield l.arrayBuffer(),etag:c||void 0,cacheControl:l.headers.get("Cache-Control")||void 0,expires:l.headers.get("Expires")||void 0}}))}};i(E,"FetchSource");var M=E;function D(e,t){let i=e.getUint32(t+4,!0),n=e.getUint32(t+0,!0);return i*r(2,32)+n}function A(e,t){let r=new DataView(e),i=r.getUint8(7);if(i>3)throw new Error(`Archive is spec version ${i} but this library supports up to spec version 3`);return{specVersion:i,rootDirectoryOffset:D(r,8),rootDirectoryLength:D(r,16),jsonMetadataOffset:D(r,24),jsonMetadataLength:D(r,32),leafDirectoryOffset:D(r,40),leafDirectoryLength:D(r,48),tileDataOffset:D(r,56),tileDataLength:D(r,64),numAddressedTiles:D(r,72),numTileEntries:D(r,80),numTileContents:D(r,88),clustered:1===r.getUint8(96),internalCompression:r.getUint8(97),tileCompression:r.getUint8(98),tileType:r.getUint8(99),minZoom:r.getUint8(100),maxZoom:r.getUint8(101),minLon:r.getInt32(102,!0)/1e7,minLat:r.getInt32(106,!0)/1e7,maxLon:r.getInt32(110,!0)/1e7,maxLat:r.getInt32(114,!0)/1e7,centerZoom:r.getUint8(118),centerLon:r.getInt32(119,!0)/1e7,centerLat:r.getInt32(123,!0)/1e7,etag:t}}function $(e){let t={buf:new Uint8Array(e),pos:0},r=d(t),i=[],n=0;for(let e=0;e<r;e++){let e=d(t);i.push({tileId:n+e,offset:0,length:0,runLength:1}),n+=e}for(let e=0;e<r;e++)i[e].runLength=d(t);for(let e=0;e<r;e++)i[e].length=d(t);for(let e=0;e<r;e++){let r=d(t);i[e].offset=0===r&&e>0?i[e-1].offset+i[e-1].length:r-1}return i}i(D,"getUint64"),i(A,"bytesToHeader"),i($,"deserializeIndex");var z=class extends Error{};i(z,"EtagMismatch");var H=z;function P(e,t){return n(this,null,(function*(){let r=yield e.getBytes(0,16384);if(19792!==new DataView(r.data).getUint16(0,!0))throw new Error("Wrong magic number for PMTiles archive");let i=A(r.data.slice(0,127),r.etag),n=r.data.slice(i.rootDirectoryOffset,i.rootDirectoryOffset+i.rootDirectoryLength),s=`${e.getKey()}|${i.etag||""}|${i.rootDirectoryOffset}|${i.rootDirectoryLength}`,o=$(yield t(n,i.internalCompression));return[i,[s,o.length,o]]}))}function Z(e,t,r,i,s){return n(this,null,(function*(){let n=yield e.getBytes(r,i,void 0,s.etag),o=$(yield t(n.data,s.internalCompression));if(0===o.length)throw new Error("Empty directory is invalid");return o}))}i(P,"getHeaderAndRoot"),i(Z,"getDirectory");var I=class{constructor(e=100,t=!0,r=w){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=r}getHeader(e){return n(this,null,(function*(){let t=e.getKey(),r=this.cache.get(t);if(r)return r.lastUsed=this.counter++,r.data;let i=yield P(e,this.decompress);return i[1]&&this.cache.set(i[1][0],{lastUsed:this.counter++,data:i[1][2]}),this.cache.set(t,{lastUsed:this.counter++,data:i[0]}),this.prune(),i[0]}))}getDirectory(e,t,r,i){return n(this,null,(function*(){let n=`${e.getKey()}|${i.etag||""}|${t}|${r}`,s=this.cache.get(n);if(s)return s.lastUsed=this.counter++,s.data;let o=yield Z(e,this.decompress,t,r,i);return this.cache.set(n,{lastUsed:this.counter++,data:o}),this.prune(),o}))}prune(){if(this.cache.size>this.maxCacheEntries){let e,t=1/0;this.cache.forEach(((r,i)=>{r.lastUsed<t&&(t=r.lastUsed,e=i)})),e&&this.cache.delete(e)}}invalidate(e){return n(this,null,(function*(){this.cache.delete(e.getKey())}))}};i(I,"ResolvedValueCache");var O=I,R=class{constructor(e=100,t=!0,r=w){this.cache=new Map,this.invalidations=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=r}getHeader(e){return n(this,null,(function*(){let t=e.getKey(),r=this.cache.get(t);if(r)return r.lastUsed=this.counter++,yield r.data;let i=new Promise(((t,r)=>{P(e,this.decompress).then((e=>{e[1]&&this.cache.set(e[1][0],{lastUsed:this.counter++,data:Promise.resolve(e[1][2])}),t(e[0]),this.prune()})).catch((e=>{r(e)}))}));return this.cache.set(t,{lastUsed:this.counter++,data:i}),i}))}getDirectory(e,t,r,i){return n(this,null,(function*(){let n=`${e.getKey()}|${i.etag||""}|${t}|${r}`,s=this.cache.get(n);if(s)return s.lastUsed=this.counter++,yield s.data;let o=new Promise(((n,s)=>{Z(e,this.decompress,t,r,i).then((e=>{n(e),this.prune()})).catch((e=>{s(e)}))}));return this.cache.set(n,{lastUsed:this.counter++,data:o}),o}))}prune(){if(this.cache.size>=this.maxCacheEntries){let e,t=1/0;this.cache.forEach(((r,i)=>{r.lastUsed<t&&(t=r.lastUsed,e=i)})),e&&this.cache.delete(e)}}invalidate(e){return n(this,null,(function*(){let t=e.getKey();if(this.invalidations.get(t))return yield this.invalidations.get(t);this.cache.delete(e.getKey());let r=new Promise(((r,i)=>{this.getHeader(e).then((e=>{r(),this.invalidations.delete(t)})).catch((e=>{i(e)}))}));this.invalidations.set(t,r)}))}};i(R,"SharedPromiseCache");var B=R,S=class{constructor(e,t,r){this.source="string"==typeof e?new M(e):e,this.decompress=r||w,this.cache=t||new B}getHeader(){return n(this,null,(function*(){return yield this.cache.getHeader(this.source)}))}getZxyAttempt(e,t,r,i){return n(this,null,(function*(){let n=f(e,t,r),s=yield this.cache.getHeader(this.source);if(e<s.minZoom||e>s.maxZoom)return;let o=s.rootDirectoryOffset,a=s.rootDirectoryLength;for(let e=0;e<=3;e++){let e=b(yield this.cache.getDirectory(this.source,o,a,s),n);if(!e)return;if(e.runLength>0){let t=yield this.source.getBytes(s.tileDataOffset+e.offset,e.length,i,s.etag);return{data:yield this.decompress(t.data,s.tileCompression),cacheControl:t.cacheControl,expires:t.expires}}o=s.leafDirectoryOffset+e.offset,a=e.length}throw new Error("Maximum directory depth exceeded")}))}getZxy(e,t,r,i){return n(this,null,(function*(){try{return yield this.getZxyAttempt(e,t,r,i)}catch(n){if(n instanceof H)return this.cache.invalidate(this.source),yield this.getZxyAttempt(e,t,r,i);throw n}}))}getMetadataAttempt(){return n(this,null,(function*(){let e=yield this.cache.getHeader(this.source),t=yield this.source.getBytes(e.jsonMetadataOffset,e.jsonMetadataLength,void 0,e.etag),r=yield this.decompress(t.data,e.internalCompression),i=new TextDecoder("utf-8");return JSON.parse(i.decode(r))}))}getMetadata(){return n(this,null,(function*(){try{return yield this.getMetadataAttempt()}catch(e){if(e instanceof H)return this.cache.invalidate(this.source),yield this.getMetadataAttempt();throw e}}))}getTileJson(e){return n(this,null,(function*(){let t=yield this.getHeader(),r=yield this.getMetadata(),i=T(t.tileType);return{tilejson:"3.0.0",scheme:"xyz",tiles:[`${e}/{z}/{x}/{y}${i}`],vector_layers:r.vector_layers,attribution:r.attribution,description:r.description,name:r.name,version:r.version,bounds:[t.minLon,t.minLat,t.maxLon,t.maxLat],center:[t.centerLon,t.centerLat,t.centerZoom],minzoom:t.minZoom,maxzoom:t.maxZoom}}))}};i(S,"PMTiles");var j=S;export{p as Compression,H as EtagMismatch,M as FetchSource,U as FileSource,j as PMTiles,l as Protocol,O as ResolvedValueCache,B as SharedPromiseCache,x as TileType,A as bytesToHeader,b as findTile,D as getUint64,s as leafletRasterLayer,d as readVarint,m as tileIdToZxy,T as tileTypeExt,f as zxyToTileId};export default null;
